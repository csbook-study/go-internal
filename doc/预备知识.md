# 预备知识

# 第一章 准备工作

## 1.1 调试源代码

Go 语言中差不多有 170 万行源代码，其中包含 160 万行的 Go 语言代码，我们可以使用如下所示的命令查看项目中代码的行数：

```bash
$ cloc src
    7819 text files.
    7518 unique files.                                          
    1760 files ignored.

github.com/AlDanial/cloc v 1.70  T=24.71 s (245.5 files/s, 90357.8 lines/s)
-----------------------------------------------------------------------------------
Language                         files          blank        comment           code
-----------------------------------------------------------------------------------
Go                                5349         167389         271718        1610483
Assembly                           531          14499          21041         117898
HTML                                 8            357              0          10467
C                                   77            822            601           4939
...
-----------------------------------------------------------------------------------
SUM:                              6067         184459         295064        1753515
-----------------------------------------------------------------------------------
```

### 编译源码

修改 Go 语言中常用方法 [`fmt.Println`](https://github.com/golang/go/blob/9ea6364a5e9f776af36604c2c20501e6d07f8467/src/fmt/print.go#L273) 的实现，实现如下所示的功能：在打印字符串之前先打印任意其它字符串。我们可以将该方法的实现修改成如下所示的代码片段，其中 `println` 是 Go 语言运行时提供的内置方法，它不需要依赖任何包就可以向标准输出打印字符串：

```go
func Println(a ...interface{}) (n int, err error) {
	println("huxiangyu")
	return Fprintln(os.Stdout, a...)
}
```

当我们修改了 Go 语言的源代码项目，修改 GOROOT 目录，并使用仓库中提供的脚本来编译生成 Go 语言的二进制以及相关的工具链：

```bash
$ export GOROOT=/root/PRJ/go/src/github.com/golang/go
```

```bash
$ ./make.bash
Building Go cmd/dist using /usr/lib/golang. (go1.17.7 linux/amd64)
Building Go toolchain1 using /usr/lib/golang.
Building Go bootstrap cmd/go (go_bootstrap) using Go toolchain1.
Building Go toolchain2 using go_bootstrap and Go toolchain1.
Building Go toolchain3 using go_bootstrap and Go toolchain2.
Building packages and commands for linux/amd64.
---
Installed Go for linux/amd64 in /root/PRJ/go/src/github.com/golang/go
Installed commands in /root/PRJ/go/src/github.com/golang/go/bin
```

脚本会编译 Go 语言的二进制、工具链以及标准库和命令并将源代码和编译好的二进制文件移动到对应的位置上。如上述代码所示，编译好的二进制会存储在 `$GOPATH/src/github.com/golang/go/bin` 目录中，这里需要使用绝对路径来访问并使用它：

```bash
$ cat main.go
package main

import "fmt"

func main() {
	fmt.Println("Hello World")
}
$ $GOPATH/src/github.com/golang/go/bin/go run main.go
huxiangyu
Hello World
```

### 中间代码

Go 语言的应用程序在运行之前需要先编译成二进制，在编译的过程中会经过中间代码生成阶段，Go 语言编译器的中间代码具有静态单赋值（Static Single Assignment、SSA）的特性。

可以使用下面的命令将 Go 语言的源代码编译成汇编语言，然后通过汇编语言分析程序具体的执行过程：

```go
$ go build -gcflags -S main.go
```

上述的汇编代码只是 Go 语言编译的结果，作为使用 Go 语言的开发者，我们已经能够通过上述结果分析程序的性能瓶颈，但是如果想要了解 Go 语言更详细的编译过程，我们可以通过下面的命令获取汇编指令的优化过程：

```bash
$ GOSSAFUNC=main go build main.go
# runtime
dumped SSA to /usr/local/Cellar/go/1.14.2_1/libexec/src/runtime/ssa.html
# command-line-arguments
dumped SSA to ./ssa.html
```

上述命令会在当前文件夹下生成一个 `ssa.html` 文件，我们打开这个文件后就能看到汇编代码优化的每一个步骤。





























